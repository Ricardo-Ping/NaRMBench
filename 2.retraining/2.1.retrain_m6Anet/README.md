## Retraining pipeline for m6Anet
## 0.Installation
```sh
$ pip install m6anet
```
- Note: We modified the original m6Anet code to add a new `$modification` ($modification: one of m1A, m7G, m6A, psU, or m5C) parameter that enables detection of other RNA modifications beyond m6A. To use this modified version, please replace the original source code with our modified version provided in `modified_code/m6Anet_modified_code.zip`.
## 1.Data preparation
The required input data here comes from the output files of step 1.preprocessing in our pipeline(bam,fastq).
m6Anet dataprep requires eventalign.txt from ``nanopolish eventalign``:
```
    # for RNA002
    nanopolish eventalign --reads reads.fastq --bam reads.sorted.bam --genome transcript.fa --scale-events --signal-index --summary /path/to/summary.txt  --threads 50 > $EVENTALIGN

    # for RNA004
    f5c eventalign --rna -b reads.bam -r reads.fastq -g transciptome.fa -o $EVENTALIGN --kmer-model /path/to/rna004.nucleotide.5mer.model --slow5 reads.blow5 --signal-index --scale-events
```
After running nanopolish eventalign, we need to preprocess the segmented raw signal file using 'm6anet dataprep':
```
m6anet dataprep --eventalign $EVENTALIGN \
                --out_dir $OUT_DIR \
                --n_processes $N_PROCESSES \
                -m $modification 
```
## 2.Feature labeling and dataset generation
To prepare for training, we use the `data.info` file generated by m6Anet dataprep. Based on known ground truth modification sites from `ground_truth_sites`, each site is assigned a binary `modification status`: 1 for modified and 0 for unmodified. The dataset is then split into Train, Test, and Validation sets in a 4:1:1 ratio by assigning the appropriate `set_type`. The final output is a `data.info.labelled` file with the following format:`transcript_id, transcript_position, start, end, n_reads, modification_status, set_type`
## 3. Model training
```
m6anet train --model_config $MODEL_CONFIG \
             --train_config $TRAIN_CONFIG \
             --save_dir $SAVE_DIR \
             --epochs 300 \
             --modification $modification
```
## 4.Model inference
```
m6anet inference --input_dir $INPUT_DIR \
                 --out_dir $OUT_DIR \
                 --model_config $MODEL_CONFIG \
                 --model_state_dict $MODEL_STATE_DICT \
                 --n_processes 32 \
                 --modification $modification
```
* ``$INPUT_DIR``: directory containing data.info and data.json
* ``$MODEL_CONFIG``: path to the model configuration file `m6Anet_modified_code/m6Anet/model/configs/model_configs/m6Anet.toml`
* ``$TRAIN_CONFIG``: path to the train configuration file `m6Anet_modified_code/m6Anet/model/configs/train_configs/m6Anet_train_config.toml`
* ``$MODEL_STATE_DICT``: path to the pretrained model weights
